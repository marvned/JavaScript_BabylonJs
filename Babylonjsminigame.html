<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<title>Мини-игра: сбор сфер на Babylon.js</title>
<style>
  html, body, #renderCanvas {
    width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden;
    background: #1a1a2e;
    display: block;
    color: white;
    font-family: Arial, sans-serif;
  }
  #score {
    position: absolute;
    top: 10px; left: 10px;
    font-size: 24px;
    z-index: 10;
  }
</style>
<script src="https://cdn.babylonjs.com/babylon.js"></script>
<script src="https://cdn.babylonjs.com/cannon.js"></script>
</head>
<body>
<div id="score"> Point you have picked up: 
  </div>
<canvas id="renderCanvas"></canvas>

<script>
  const canvas = document.getElementById("renderCanvas");
  const engine = new BABYLON.Engine(canvas, true);
  let score = 0;
  const scoreDiv = document.getElementById("score");

  const createScene = () => {
    const scene = new BABYLON.Scene(engine);
    scene.enablePhysics(new BABYLON.Vector3(0, -9.81, 0), new BABYLON.CannonJSPlugin());

    // cmr view abv angl
    const camera = new BABYLON.ArcRotateCamera("camera", Math.PI / 4, Math.PI / 3, 15, new BABYLON.Vector3(0, 0, 0), scene);
    camera.attachControl(canvas, true);

    // light
    const light = new BABYLON.HemisphericLight("light", new BABYLON.Vector3(0, 1, 0), scene);

    // floor
    const ground = BABYLON.MeshBuilder.CreateGround("ground", {width: 20, height: 20}, scene);
    ground.physicsImpostor = new BABYLON.PhysicsImpostor(
      ground,
      BABYLON.PhysicsImpostor.BoxImpostor,
      { mass: 0, restitution: 0.9 },
      scene
    );

    // Hero: blue bally ball with physics reacting on WSAD
    const player = BABYLON.MeshBuilder.CreateSphere("player", {diameter: 1}, scene);
    player.position.y = 1;
    player.physicsImpostor = new BABYLON.PhysicsImpostor(
      player,
      BABYLON.PhysicsImpostor.SphereImpostor,
      { mass: 1, restitution: 0.7, friction: 0.5 },
      scene
    );
    const playerMat = new BABYLON.StandardMaterial("playerMat", scene);
    playerMat.diffuseColor = new BABYLON.Color3(0.1, 0.6, 1);
    player.material = playerMat;

    // Ylw vorota
    const items = [];
    const itemCount = 10;

    for(let i=0; i<itemCount; i++) {
      const item = BABYLON.MeshBuilder.CreateSphere("item" + i, {diameter: 0.5}, scene);
      item.position = new BABYLON.Vector3(
        (Math.random() - 0.5) * 18,
        0.25,
        (Math.random() - 0.5) * 18
      );
      item.physicsImpostor = new BABYLON.PhysicsImpostor(
        item,
        BABYLON.PhysicsImpostor.SphereImpostor,
        { mass: 0, restitution: 0.9 },
        scene
      );
      const itemMat = new BABYLON.StandardMaterial("itemMat" + i, scene);
      itemMat.diffuseColor = new BABYLON.Color3(1, 0.8, 0.2);
      item.material = itemMat;
      items.push(item);
    }

    // Controllers of the movement 
    const inputMap = {};
    scene.actionManager = new BABYLON.ActionManager(scene);
    scene.actionManager.registerAction(new BABYLON.ExecuteCodeAction(BABYLON.ActionManager.OnKeyDownTrigger, (evt) => {
      inputMap[evt.sourceEvent.key.toLowerCase()] = true;
    }));
    scene.actionManager.registerAction(new BABYLON.ExecuteCodeAction(BABYLON.ActionManager.OnKeyUpTrigger, (evt) => {
      inputMap[evt.sourceEvent.key.toLowerCase()] = false;
    }));

    // power with which marianshenka move a square
    const forceMagnitude = 5;

    scene.onBeforeRenderObservable.add(() => {
      let force = new BABYLON.Vector3(0, 0, 0);

      if(inputMap["w"] || inputMap["arrowup"]) force.z += 1;
      if(inputMap["s"] || inputMap["arrowdown"]) force.z -= 1;
      if(inputMap["a"] || inputMap["arrowleft"]) force.x -= 1;
      if(inputMap["d"] || inputMap["arrowright"]) force.x += 1;

      force = force.normalize().scale(forceMagnitude);

      player.physicsImpostor.applyForce(force, player.getAbsolutePosition());

      // Proverka stolknoveniya s object
      for(let i = items.length - 1; i >= 0; i--) {
        if(player.intersectsMesh(items[i], false)) {
          // kill objct n give score more
          items[i].dispose();
          items.splice(i, 1);
          score++;
          scoreDiv.textContent = "I have catched: " + score;
        }
      }
    });

    return scene;
  };

  const scene = createScene();

  engine.runRenderLoop(() => {
    scene.render();
  });

  window.addEventListener("resize", () => {
    engine.resize();
  });
</script>
</body>
</html>
